import pandas as pd
import mysql.connector
import os
import warnings

warnings.filterwarnings('ignore')  # ignore warnings

CURRENT_FILE_NAME = 'real_es.csv'
FILE_SEPERATOR = ','
PATH ='/Users/hoangduyanh/Documents/PythonProjects/python-etl/nan.csv'


def file_reader(file_name, seperator):
    return pd.read_csv(CURRENT_FILE_NAME, FILE_SEPERATOR)

def file_information(file_data):
    '''
    display informations about file
    '''
    length_rows = len(file_data)
    length_columns = len(file_data.columns)
    columns_header = list(file_data.columns)
    df_data_type = file_data.dtypes
    print(f"This file has: {length_rows} rows, and {length_columns} columns.\nColumns: \n{columns_header}\nDatatypes:\n{df_data_type}")

def save_nan_to_csv(file_data):
    '''
    save NaN to csv
    '''
    missing_values = file_data[file_data.isna().any(axis=1)]
    missing_values.fillna('missing data', inplace=True)
    os.makedirs('NaN/subfolder', exist_ok=True)
    missing_values.to_csv(PATH) 

def file_cleaner(file_data):
    '''
    Cleaning data and creating new also
    '''
    df = file_data[~file_data.isna().any(axis=1)] # drop NaN
    df['Price'] = df['Price'].str.replace('$','').str.replace(',','').astype(float) # convert price to float
    df['Square meter'] = (df['Area (ft.)'] * 0.09290304).round(2) # convert feet to meter
    df['Price per meter'] = (df['Price'] / df['Square meter']).round(2) # calculate price/meter
    df['Sales ID'] = df['ID'].map(str) + df['Customer ID'] # generate sales ID
    df[['Year of sale', 'Month of sale', 'Y', 'M', 'D']] = df[['Year of sale', 'Month of sale', 'Y', 'M', 'D']].astype(int) # convert to integer
    return df

def customers_table(clean_file):
    customer_table = clean_file[['Customer ID', 'Name', 'Surname', 'Gender']]
    rename_customer = customer_table.rename(columns={"Customer ID": "customer_id","Name": "name","Surname": "surname", "Gender": "gender"})
    final_customer_table = rename_customer.drop_duplicates(subset='customer_id', keep='last')
    return final_customer_table
    

def properties_table(clean_file):
    property_table = clean_file[['ID', 'Building', 'Type of property', 'Property #', 'Area (ft.)', 'Status', 'Square meter', 'Customer ID','Country', 'State']]
    rename_property = property_table.rename(columns={'ID': "id", 'Building': 'building', 'Type of property': 'type_of_property', 'Property #': 'property_no',\
     'Area (ft.)': 'area_in_ft', 'Status': 'status', 'Square meter': 'square_meter', 'Customer ID': 'customer_id','Country': 'country', 'State': 'state'})
    final_property_table = rename_property.drop_duplicates(subset='id', keep='last')
    return final_property_table

def sales_table(clean_file):
    sale_table = clean_file[['ID', 'Building', 'Type of property', 'Property #', 'Area (ft.)', 'Status', 'Square meter', 'Customer ID','Country', 'State']]
    rename_sale = property_table.rename(columns={'ID': "id", 'Building': 'building', 'Type of property': 'type_of_property', 'Property #': 'property_no',\
     'Area (ft.)': 'area_in_ft', 'Status': 'status', 'Square meter': 'square_meter', 'Customer ID': 'customer_id','Country': 'country', 'State': 'state'})
    final_sale_table = rename_sale.drop_duplicates(subset='id', keep='last')
    return final_sale_table

def main():
    file_data = file_reader(CURRENT_FILE_NAME, FILE_SEPERATOR)
    #file_info = file_information(file_data)
    #save_csv = save_nan_to_csv(file_data)
    clean_file = file_cleaner(file_data)
    customers = customers_table(clean_file)
    property = properties_table(clean_file)
    


# starting point of file
if __name__ == '__main__':
    main()